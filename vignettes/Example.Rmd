---
title: "Gross and net flow estimation using the `surf` package"
author: "Guilherme Jacob"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, echo=FALSE}
knitr::opts_chunk$set( echo = TRUE, message = FALSE, warning = FALSE )
options( digits = 1 )
```

## Setting up the `survey.flow design` object

Understanding how survey data was collected is the first step in any analysis. In the case of complex surveys, this implies knowing if the sample includes clustering, stratification, unequal probabilities, post-stratification, etc. Much like the `survey` package, `surf` uses an object that summarizes that information. The only difference between `survey::svydesign` and `surf::sfydesign` is in the `data` argument: `sfydesign` requires a list of `data.frames`.  Why? Because *each round* of the survey produces *a dataset*, but they are *dependent of the initial sample*. 

A `survflow.design` can be created like this:

```{r}
# load package
library(surf)

# load artificial data
data("artificial")

# build survflow.design design
flowdes <-
  sfydesign( ids = ~0 ,
             fpc = ~ 1/prob ,
             data = list( dfa0 , dfa1 ) ,
             nest = TRUE )

# summarizes the object
summary( flowdes )
```

The results are much like the `summary` on a `survey design` object, except for: (1) the *number of repetitions*, which counts the number of repeated samples (i.e., number of datasets minus the initial dataset); and (2) the *data variables*, which shows the variables that appears in all datasets (i.e., the intersection of variable lists of each dataset).

## Estimating Gross and Net Flows

In order to estimate flows between categories across two survey rounds, we should use the `svyflow` function. For now, let's estimate the changes between categories in `v0` across the rounds `0` and `1`:

```{r}
# estimate gross flows
gflow <- svyflow( ~v0 , flowdes , rounds = c(0,1) )

# show rounded point estimates of gross flows
round( coef( gflow ) , 0 )
```

Compare this with our population values:
```{r echo=FALSE}
pop_gross <- coef( gflow )
pop_gross[,] <- surf:::muij_pop
pop_gross
```

*Quite close, aren't they?*

Another important measure is the *standard error* of the estimates, extracted using the `SE` function:
```{r}
# show rounded standard errors of gross flows
round( SE( gflow ) , 0 )
```

For net flows, we should change the `flow.type` argument in `svyflow`. Therefore:

```{r}
# estimate net flows
nflow <- svyflow( ~v0 , flowdes , rounds = c(0,1) , flow.type = "net" )

# show point estimates of net flows
coef( nflow )
```

Again, compare this with our population values:
```{r echo=FALSE}
pop_net <- coef( nflow )
pop_net[,] <- surf:::nipij_pop
pop_net
```

You can also extract the `SE` from these objects:
```{r}
# show standard errors of net flows
SE( nflow )
```
